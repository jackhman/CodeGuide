---
title: 第13节：引入分库分表路由组件
pay: https://t.zsxq.com/18oeNp26S
---

# 《大营销平台系统设计实现》 - 营销服务 第13节：引入分库分表路由组件

作者：小傅哥
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

>沉淀、分享、成长，让自己和他人都能有所收获！😄

- **本章难度**：★★★☆☆
- **本章重点**：讲解分库分表路由的作用，并对工程配置路由组件以及测试验证。后续章节将在路由组件的继续上继续开发业务流程。
- **课程视频**：[https://t.zsxq.com/18MieGCE4](https://t.zsxq.com/18MieGCE4)

**版权说明**：©本项目与星球签约合作，受[《中华人民共和国著作权法实施条例》](http://www.gov.cn/zhengce/2020-12/26/content_5573623.htm) 版权法保护，禁止任何理由和任何方式公开(public)源码、资料、视频等内容到Github、Gitee等，违反可追究进一步的法律行动。

## 一、本章诉求

为用户的行为数据，使用路由组件将数据散列到分库分表中。

分库分表也是分布式架构中一个非常常用的数据存储方案，通常在公司中创建的系统都是直接创建出带有分库分表的系统架构。因为本身本身分库分表就是一个很成熟的方案，系统的分层和开发的熟练度都非常高。如果早期设计为单库单表的，那么后期再想扩展为分库分表则会有非常大的数据迁移和工程改造成本。

那么，分库分表以后，早期需要更多的数据库资源吗？其实并不用的，对于早期上线的系统，如果评估没那么大的体量，则可以使用虚拟机的方案安装数据库，也就是原来1台物理机，装1个数据库，现在则是2台物理机拆分为虚拟机，各个应用互相使用【作为主备】。而你占用的都是虚拟资源。也就是原来1台物理机等于5个虚拟机，现在5个虚拟机被分配到各个物理机上。所以你的分库分表并没有额外占用更多的资源。但这样的设计，业务体量上来以后，扩展只需要调整虚拟机的分配就可以了。

## 二、功能流程

在大营销的系统设计中，有一个配置库（big_market）和两个分库（big_market_01、big_market_02），我们需要对两个分库进行配置路由操作。达到分库分表的目的，而配置库则是一个单库单表存储活动等配置类信息。分库分表调用流程【如图】

<div align="center">
    <img src="https://bugstack.cn/images/article/project/big-market/big-market-20-01.png" width="800px">
</div>

- 以用户对数据库的操作为视角，发生用户类的行为操作时【账户、下单、流水】，则会根据用户ID（userId）进行路由，把数据分配到x库y表中。
- 路由计算的处理，是以配置了 `@DBRouter`注解的 DAO 方法进行路由切面开始。通过获取用户ID（userId）值进行哈希索引计算。哈希值 & 2从n次幂数量的库表 - 1 得到一个值，在根据这个值计算应该分配到哪个库表上去。比如这个是6，分库分表是2库4表，共计8个，那么6就分配到了1库4+2库2个等于6，也就得到了2库2表。
- 对于计算得到的分库分表值，存入到 ThreaLocal 中，这个东西的目的是可以在一个线程的调用中，可以随时获取值，而不需要通过方法传递。
- 最后 Spring 在执行数据库操作前，会获取路由。而路由组件则实现了动态路由，从 ThreadLocal 中获取。此外注意，因为还有分表的操作，比如 table 需要为 table_01 这个动作是由 MyBatis Plugin 插件开发实现的。

关于数据库路由组件单独录制了课程，更多细节内容可以学习。[数据库分库分表路由组件](https://bugstack.cn/md/road-map/db-router.html) - 这个小组件足够写个简历项目用。

此外 [sharding-jdbc](https://bugstack.cn/md/road-map/sharding-jdbc.html) 也可以做分库分表，但直接使用小伙伴们会错过理解分库分表的核心设计，所以我们这里选择使用星球「码农会锁」里的 DB-Router 进行分库分表。
