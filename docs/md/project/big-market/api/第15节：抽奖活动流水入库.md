---
title: 第15节：抽奖活动流水入库
pay: https://t.zsxq.com/18mWcNHOp
---

# 《大营销平台系统设计实现》 - 营销服务 第15节：抽奖活动流水入库

作者：小傅哥
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

>沉淀、分享、成长，让自己和他人都能有所收获！😄

- **本章难度**：★★★☆☆
- **本章重点**：实现抽奖下单对活动账户充值的操作流程，把数据写入到库中，并可以保证幂等性。
- **课程视频**：[https://t.zsxq.com/18gaoKYEn](https://t.zsxq.com/18gaoKYEn)

**版权说明**：©本项目与星球签约合作，受[《中华人民共和国著作权法实施条例》](http://www.gov.cn/zhengce/2020-12/26/content_5573623.htm) 版权法保护，禁止任何理由和任何方式公开(public)源码、资料、视频等内容到Github、Gitee等，违反可追究进一步的法律行动。

## 一、本章诉求

在基于活动、次数所组合的活动 sku，用户参与活动就相当于，下单sku给自己的活动账户充值可参与的额度次数。所以本节小傅哥就带着大家，把活动的下单的过程落入到数据库中。

本节写库会涉及到分库分表组件切分和开启事务的操作。

## 二、功能流程

按照上一节我们对活动流程的设计，用户参与抽奖活动就会有一个活动额度账户，而本节则让来实现参与活动对自己的活动额度账户充值的过程。

<div align="center">
    <img src="https://bugstack.cn/images/article/project/big-market/big-market-22-01.png" width="750px">
</div>

- 本节会先实现出领取活动的框架结构代码，并对数据进行落库操作。（落库的过程会有分库分表下事务的操作）
- 活动日期、活动状态、sku库存校验和扣减，这些都是固定的流程。无论创建多少个活动都会走这样的统一流程，所以这里适合添加一个责任链模式的结构。
- 因为是分库分表设计，所以库表数据的写入需要确定切分键，并在同一个连接下执行 commit 这样才能把用户的活动账户和订单流程，一起写库。（也就是一个事务的特性）