---
title: 第17节：用于领取活动库表设计
pay: https://t.zsxq.com/18Hf0vgQV
---

# 《大营销平台系统设计实现》 - 营销服务 第17节：用于领取活动库表设计

作者：小傅哥
<br/>博客：[https://bugstack.cn](https://bugstack.cn)

>沉淀、分享、成长，让自己和他人都能有所收获！😄

- **本章难度**：★★★★☆
- **本章重点**：分析抽奖业务流程并设计出对应的库表，本节会新增5张库表。
- **课程视频**：[https://t.zsxq.com/18R7A8BsN](https://t.zsxq.com/18R7A8BsN)

**版权说明**：©本项目与星球签约合作，受[《中华人民共和国著作权法实施条例》](http://www.gov.cn/zhengce/2020-12/26/content_5573623.htm) 版权法保护，禁止任何理由和任何方式公开(public)源码、资料、视频等内容到Github、Gitee等，违反可追究进一步的法律行动。

## 一、本章诉求

设计用于，用户参与活动所需的库表。从用户参与活动，扣减个人活动账户次数，创建活动订单。抽奖完成获得奖品ID后，写入中奖记录和task任务表（发mq补偿使用）。之后发送MQ消息，更新中奖记录。

这一套流程，需要本节增加6张表。—— 小傅哥给大家的这些设计，都是来自于真实的场景中，而不是随便一张库表就只写 CRUD 。

## 二、业务流程

从业务流程的模型结构分析，看整个链路所需的库表；

<div align="center">
    <img src="https://bugstack.cn/images/article/project/big-market/big-market-24-01.png" width="850px">
</div>

- 首先，用户抽奖开始，需要领取活动，扣减个人账户额度。生成一个抽奖订单。每个用户都有一个活动账户额度，里面包含了；总可参与次数、月可参与次数、日可参与次数。这样的设计是为了应对复杂的业务需求。那么有这样的表，就不能只是在一个表里扣减额度，因为每天都要扣减额度，但只在一个账户中扣减，日的次数第一天扣减完，第二天相当于回复为原始库存继续扣减。所以这里要生成一个出每日活动账户，当前则在自己的日账户中扣减。而总库存的日，是一种镜像记录，方便查询统计的。
- 账户，在扣减额度和用户的订单，要在一个事务内完成。但不能和后续的抽奖结果继续做事务，因为抽奖的过程还有很多的操作，而已包括缓存的处理，而他们都不能做事务。所以这部分是分开的。
- 之后，抽奖策略结果计算完毕后，把奖品ID写入中奖记录表中，同时写一个 task 任务表。任务表是发 MQ 消息的。但在写入完成奖品订单后，则直接发送一个 MQ 消息【发送后更新 task 表状态】，如果发送失败则还有 task 任务表，由 job 任务扫描的方式处理。这样可以尽快的发送 MQ 消息。
- 最后，接收发送的 MQ 开始发放奖品，本节暂时先不处理奖品的发放。
